<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Donation Form - HCR Foundation</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    /* Your existing CSS styles */
  </style>
</head>
<body>
  <section id="donation_form">
    <div class="form-container">
      <div class="form-header">
        <h1>HCRF Foundation Donation</h1>
        <p>Support our mission to preserve traditional crafts</p>
      </div>

      <div class="form-progress">
        <div class="progress-steps">
          <div class="step active" data-step="1">
            <div class="step-circle">1</div>
            <div class="step-title">Donation Amount</div>
          </div>
          <div class="step" data-step="2">
            <div class="step-circle">2</div>
            <div class="step-title">Donation Pool</div>
          </div>
          <div class="step" data-step="3">
            <div class="step-circle">3</div>
            <div class="step-title">Personal Info</div>
          </div>
          <div class="step" data-step="4">
            <div class="step-circle">4</div>
            <div class="step-title">Payment</div>
          </div>
        </div>
      </div>

      <form id="donation-form" novalidate>
        <!-- Step 1: Donation Amount -->
        <div class="form-step active" id="step-1">
          <fieldset>
            <legend>Donation Amount</legend>
            <div class="form-row">
              <div class="form-col-full">
                <div class="radio-group">
                  <label>Select Amount</label>
                  <div class="radio-option">
                    <input type="radio" id="amount125" name="amount" value="125" required />
                    <span>₹125</span>
                  </div>
                  <div class="radio-option">
                    <input type="radio" id="amount500" name="amount" value="500" required />
                    <span>₹500</span>
                  </div>
                  <div class="radio-option">
                    <input type="radio" id="amount1000" name="amount" value="1000" required />
                    <span>₹1000</span>
                  </div>
                  <div class="radio-option">
                    <input type="radio" id="amount2500" name="amount" value="2500" required />
                    <span>₹2500</span>
                  </div>
                  <div class="radio-option">
                    <input type="radio" id="customAmountRadio" name="amount" value="custom" required />
                    <span>Custom Amount:</span>
                    <input type="number" id="customAmount" name="customAmount" step="0.01" placeholder="Enter custom amount" disabled />
                  </div>
                </div>
              </div>
            </div>
          </fieldset>
          <div class="form-buttons">
            <div></div>
            <button type="button" class="btn btn-next" data-next="2">Next Step <i class="fas fa-arrow-right"></i></button>
          </div>
        </div>

        <!-- Your existing HTML for Steps 2, 3, and 4 -->
      </form>
    </div>
  </section>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('donation-form');
      const steps = document.querySelectorAll('.form-step');
      const progressSteps = document.querySelectorAll('.step');
      const nextButtons = document.querySelectorAll('.btn-next');
      const prevButtons = document.querySelectorAll('.btn-prev');
      const paymentButton = document.getElementById('rzp-button');
      const originalButtonHTML = paymentButton.innerHTML;

      // Enable custom amount input when custom amount radio is selected
      const customAmountRadio = document.getElementById('customAmountRadio');
      const customAmountInput = document.getElementById('customAmount');

      customAmountRadio.addEventListener('change', function() {
        if (this.checked) {
          customAmountInput.disabled = false;
          customAmountInput.focus();
        } else {
          customAmountInput.disabled = true;
        }
      });

      // Scroll to top of form container when navigating steps
      function scrollToTop() {
        document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });
      }

      // Navigate between steps
      function navigateToStep(button, direction) {
        const currentStepNum = parseInt(button.getAttribute(`data-${direction}`)) - (direction === 'next' ? 1 : 0);
        const targetStepNum = parseInt(button.getAttribute(`data-${direction}`));

        if (validateStep(currentStepNum)) {
          updateStep(targetStepNum);
          scrollToTop(); // Scroll to top after updating step
        }
      }

      // Update step visibility and progress indicators
      function updateStep(stepNum) {
        steps.forEach(step => step.classList.remove('active'));
        progressSteps.forEach(step => {
          const stepNumber = parseInt(step.getAttribute('data-step'));
          step.classList.remove('active', 'completed');
          if (stepNumber < stepNum) step.classList.add('completed');
          else if (stepNumber === stepNum) step.classList.add('active');
        });

        document.getElementById(`step-${stepNum}`).classList.add('active');

        if (stepNum === 4) populateReviewDetails();
      }

      // Validate form steps
      function validateStep(stepNum) {
        const currentStep = document.getElementById(`step-${stepNum}`);
        let isValid = true;

        if (stepNum === 1) {
          isValid = validateDonationAmount();
        } else if (stepNum === 2) {
          isValid = validateDonationPool();
        } else if (stepNum === 3) {
          isValid = validatePersonalInfo();
        }

        return isValid;
      }

      // Validate Donation Amount (Step 1)
      function validateDonationAmount() {
        const amountSelected = document.querySelector('input[name="amount"]:checked') !== null;
        if (!amountSelected) {
          alert("Please select a donation amount.");
          return false;
        }
        return true;
      }

      // Validate Donation Pool (Step 2)
      function validateDonationPool() {
        const poolSelected = document.querySelector('input[name="pool"]:checked') !== null;
        if (!poolSelected) {
          alert("Please select a donation pool.");
          return false;
        }
        return true;
      }

      // Validate Personal Information (Step 3)
      function validatePersonalInfo() {
        let isValid = true;
        const firstName = document.getElementById('firstName');
        const lastName = document.getElementById('lastName');
        const email = document.getElementById('email');
        const phone = document.getElementById('phone');
        const streetAddress = document.getElementById('streetAddress');
        const city = document.getElementById('city');
        const state = document.getElementById('state');
        const zip = document.getElementById('zip');
        const country = document.getElementById('country');

        if (!firstName.value.trim()) {
          showError(firstName, 'Please enter your first name');
          isValid = false;
        } else {
          hideError(firstName);
        }

        if (!lastName.value.trim()) {
          showError(lastName, 'Please enter your last name');
          isValid = false;
        } else {
          hideError(lastName);
        }

        if (!email.value.trim() || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.value)) {
          showError(email, 'Please enter a valid email address');
          isValid = false;
        } else {
          hideError(email);
        }

        if (!phone.value.trim()) {
          showError(phone, 'Please enter your phone number');
          isValid = false;
        } else {
          hideError(phone);
        }

        if (!streetAddress.value.trim()) {
          showError(streetAddress, 'Please enter your street address');
          isValid = false;
        } else {
          hideError(streetAddress);
        }

        if (!city.value.trim()) {
          showError(city, 'Please enter your city');
          isValid = false;
        } else {
          hideError(city);
        }

        if (!state.value.trim()) {
          showError(state, 'Please enter your state');
          isValid = false;
        } else {
          hideError(state);
        }

        if (!zip.value.trim()) {
          showError(zip, 'Please enter your zip code');
          isValid = false;
        } else {
          hideError(zip);
        }

        if (!country.value.trim()) {
          showError(country, 'Please enter your country');
          isValid = false;
        } else {
          hideError(country);
        }

        return isValid;
      }

      // Show error message
      function showError(input, message) {
        const formElement = input.closest('.floating-label');
        formElement.classList.add('error');
        const errorElement = formElement.querySelector('.form-error');
        if (errorElement) {
          errorElement.textContent = message;
          errorElement.style.display = 'block';
        }
      }

      // Hide error message
      function hideError(input) {
        const formElement = input.closest('.floating-label');
        formElement.classList.remove('error');
        const errorElement = formElement.querySelector('.form-error');
        if (errorElement) {
          errorElement.style.display = 'none';
        }
      }

      // Populate review details (Step 4)
      function populateReviewDetails() {
        const reviewContainer = document.getElementById('review-details');
        const formData = getFormData();

        const html = `
          <div class="review-section">
            <h3 style="margin-bottom: 15px; color: #3498db;">Personal Information</h3>
            <div class="review-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
              <div><strong>Name:</strong> ${formData.firstName} ${formData.lastName}</div>
              <div><strong>Email:</strong> ${formData.email}</div>
              <div><strong>Phone:</strong> ${formData.phone}</div>
              <div><strong>Address:</strong> ${formData.streetAddress}, ${formData.city}, ${formData.state}, ${formData.zip}, ${formData.country}</div>
            </div>
            <h3 style="margin-bottom: 15px; color: #3498db;">Donation Details</h3>
            <div class="review-box" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db;">
              <div style="font-size: 18px; font-weight: 600; margin-bottom: 5px;">Donation Amount</div>
              <div style="font-size: 20px; color: #3498db; font-weight: 700;">₹${formData.amount}</div>
              <div style="font-size: 16px; margin-top: 10px;"><strong>Donation Pool:</strong> ${formData.pool}</div>
            </div>
          </div>
        `;

        reviewContainer.innerHTML = html;
      }

      // Handle payment process
      async function handlePayment() {
        if (!validateStep(1) || !validateStep(2) || !validateStep(3)) {
          alert("Please complete all required fields before proceeding to payment.");
          return;
        }

        paymentButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        paymentButton.disabled = true;

        try {
          const formData = getFormData();
          const amount = formData.amount * 100; // Convert to paise

          const response = await fetch("https://api.khcrf.org/api/payment/create-order", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              amount,
              currency: "INR",
              type: "donation",
              receipt: `DONATION_${Date.now()}_${Math.floor(Math.random() * 1000)}`,
              metadata: formData
            })
          });

          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
          const data = await response.json();
          if (!data.order) throw new Error("Order data not found in response");

          const options = {
            key: "rzp_live_0Imfta5OKjsu0J", // Replace with your Razorpay key
            amount: data.order.amount,
            currency: data.order.currency,
            name: "HAMADAN CRAFT REVIVAL FOUNDATION",
            description: "Donation Payment",
            order_id: data.order.id,
            handler: async function (response) {
              await verifyPayment(response, formData);
            },
            prefill: {
              name: `${formData.firstName} ${formData.lastName}`,
              email: formData.email,
              contact: formData.phone
            },
            theme: { color: "#3399cc" },
            modal: { ondismiss: () => resetPaymentButton() }
          };

          const rzp = new Razorpay(options);
          rzp.on('payment.failed', () => {
            alert('Payment failed. Please try again.');
            resetPaymentButton();
          });

          rzp.open();
        } catch (error) {
          console.error("Error in payment:", error);
          alert("An error occurred while processing your payment. Please try again.");
          resetPaymentButton();
        }
      }

      // Reset payment button to original state
      function resetPaymentButton() {
        paymentButton.innerHTML = originalButtonHTML;
        paymentButton.disabled = false;
      }

      // Verify payment
      async function verifyPayment(paymentData, formData) {
        try {
          const verifyRes = await fetch("https://api.khcrf.org/api/payment/verify", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              ...paymentData,
              donationDetails: formData
            }),
          });

          const result = await verifyRes.json();
          if (result.success) {
            showSuccessMessage();
            form.reset();
            updateStep(1);
          } else {
            alert("Payment verification failed. Please contact support.");
            resetPaymentButton();
          }
        } catch (error) {
          console.error("Verification Error:", error);
          console.log("An error occurred while verifying your payment. Please contact support.");
          resetPaymentButton();
        }
      }

      // Show success message
      function showSuccessMessage() {
        const formContainer = document.querySelector('.form-container');
        formContainer.innerHTML = `
          <div style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 80px; color: #2ecc71; margin-bottom: 20px;">
              <i class="fas fa-check-circle"></i>
            </div>
            <h2 style="font-size: 28px; color: #2c3e50; margin-bottom: 15px;">Payment Successful!</h2>
            <p style="font-size: 18px; color: #7f8c8d; margin-bottom: 30px;">Thank you for your donation to the HCR Foundation.</p>
            <p style="font-size: 16px; color: #7f8c8d; margin-bottom: 30px;">A confirmation email has been sent to your registered email address.</p>
            <a href="index.html" style="display: inline-block; padding: 12px 25px; background-color: #3498db; color: white; text-decoration: none; border-radius: 5px; font-weight: 600;">Back to Homepage</a>
          </div>
        `;
      }

      // Helper Functions

      // Get form data
      function getFormData() {
        return {
          firstName: document.getElementById('firstName').value,
          lastName: document.getElementById('lastName').value,
          email: document.getElementById('email').value,
          phone: document.getElementById('phone').value,
          streetAddress: document.getElementById('streetAddress').value,
          city: document.getElementById('city').value,
          state: document.getElementById('state').value,
          zip: document.getElementById('zip').value,
          country: document.getElementById('country').value,
          amount: document.querySelector('input[name="amount"]:checked').value,
          pool: document.querySelector('input[name="pool"]:checked')?.value || 'Not selected',
          paymentMethod: 'razorpay'
        };
      }

      // Add event listeners for next and previous buttons
      nextButtons.forEach(button => {
        button.addEventListener('click', () => navigateToStep(button, 'next'));
      });

      prevButtons.forEach(button => {
        button.addEventListener('click', () => navigateToStep(button, 'prev'));
      });

      // Add event listener for payment button
      paymentButton.addEventListener('click', handlePayment);
    });
  </script>
</body>
</html>